{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="game-header">
    <div id="game-info">
        <!-- Game info will be populated via JavaScript -->
        <p class="loading-message">Loading game information...</p>
    </div>
</div>

<div class="game-content-grid">
    <div class="main-content">
        <div class="card">
        <h2>Box Score</h2>
        <div class="tab-container">
            <div class="tabs">
                <button class="tab-btn active" data-tab="away-team">Away Team</button>
                <button class="tab-btn" data-tab="home-team">Home Team</button>
            </div>

            <div class="tab-content active" id="away-team">
                <h3 id="away-team-name">Away Team</h3>
                <table class="data-table box-score-table" id="away-team-table">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>MIN</th>
                            <th>PTS</th>
                            <th>REB</th>
                            <th>AST</th>
                            <th>STL</th>
                            <th>BLK</th>
                            <th>FG</th>
                            <th>3PT</th>
                            <th>FT</th>
                            <th>TO</th>
                            <th>PF</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="12" class="loading-message">Loading player stats...</td>
                        </tr>
                    </tbody>
                    <tfoot id="away-team-totals">
                        <!-- Team totals will be populated via JavaScript -->
                    </tfoot>
                </table>
            </div>

            <div class="tab-content" id="home-team">
                <h3 id="home-team-name">Home Team</h3>
                <table class="data-table box-score-table" id="home-team-table">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>MIN</th>
                            <th>PTS</th>
                            <th>REB</th>
                            <th>AST</th>
                            <th>STL</th>
                            <th>BLK</th>
                            <th>FG</th>
                            <th>3PT</th>
                            <th>FT</th>
                            <th>TO</th>
                            <th>PF</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="12" class="loading-message">Loading player stats...</td>
                        </tr>
                    </tbody>
                    <tfoot id="home-team-totals">
                        <!-- Team totals will be populated via JavaScript -->
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

        <div class="card">
            <h2>Shooting Chart</h2>
            <div class="chart-container">
                <canvas id="shooting-chart"></canvas>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card" id="top-players-card">
            <h2>Game Leaders</h2>
            <div class="top-players-container">
                <div class="top-player-box away-player">
                    <div class="player-photo-placeholder">
                        <svg width="50" height="50" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="30" cy="30" r="30" fill="#E5E7EB"/>
                            <path d="M30 32C34.4183 32 38 28.4183 38 24C38 19.5817 34.4183 16 30 16C25.5817 16 22 19.5817 22 24C22 28.4183 25.5817 32 30 32Z" fill="#9CA3AF"/>
                            <path d="M30 36C21.1634 36 14 43.1634 14 52V60H46V52C46 43.1634 38.8366 36 30 36Z" fill="#9CA3AF"/>
                        </svg>
                    </div>
                    <div class="player-info">
                        <h3 class="team-name" id="away-top-team-name">Away Team</h3>
                        <p class="player-name" id="away-top-player-name">-</p>
                        <p class="player-stats" id="away-top-player-stats">-</p>
                    </div>
                </div>
                <div class="top-player-box home-player">
                    <div class="player-photo-placeholder">
                        <svg width="50" height="50" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="30" cy="30" r="30" fill="#E5E7EB"/>
                            <path d="M30 32C34.4183 32 38 28.4183 38 24C38 19.5817 34.4183 16 30 16C25.5817 16 22 19.5817 22 24C22 28.4183 25.5817 32 30 32Z" fill="#9CA3AF"/>
                            <path d="M30 36C21.1634 36 14 43.1634 14 52V60H46V52C46 43.1634 38.8366 36 30 36Z" fill="#9CA3AF"/>
                        </svg>
                    </div>
                    <div class="player-info">
                        <h3 class="team-name" id="home-top-team-name">Home Team</h3>
                        <p class="player-name" id="home-top-player-name">-</p>
                        <p class="player-stats" id="home-top-player-stats">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Get game ID from URL path
    const pathParts = window.location.pathname.split('/');
    const gameId = pathParts[pathParts.length - 1];

    document.addEventListener('DOMContentLoaded', function() {
        // Load game information
        fetch(`/v1/games/${gameId}`)
            .then(response => response.json())
            .then(game => {
                document.getElementById('game-info').innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h2>${game.away_team} @ ${game.home_team}</h2>
                            <p class="game-date">${formatDate(game.date)}</p>
                            <p class="game-score">${game.away_score} - ${game.home_score}</p>
                        </div>
                        <a href="/games/${gameId}/edit-stats" class="btn btn-primary">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Edit Stats
                        </a>
                    </div>
                `;
            });

        // Load box score
        loadBoxScore();

        // Set up tab switching
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');

                // Update active tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(this.dataset.tab).classList.add('active');
            });
        });
    });

    function loadBoxScore() {
        fetch(`/v1/games/${gameId}/box-score`)
            .then(response => response.json())
            .then(data => {
                // Update team names
                document.getElementById('away-team-name').textContent = data.away_team.name;
                document.getElementById('home-team-name').textContent = data.home_team.name;

                // Update top players section
                if (data.away_team.top_player) {
                    document.getElementById('away-top-team-name').textContent = data.away_team.name;
                    document.getElementById('away-top-player-name').textContent = data.away_team.top_player.name;
                    document.getElementById('away-top-player-stats').textContent = 
                        `${data.away_team.top_player.points} PTS, ${data.away_team.top_player.fg_percentage.toFixed(1)}% FG`;
                }
                
                if (data.home_team.top_player) {
                    document.getElementById('home-top-team-name').textContent = data.home_team.name;
                    document.getElementById('home-top-player-name').textContent = data.home_team.top_player.name;
                    document.getElementById('home-top-player-stats').textContent = 
                        `${data.home_team.top_player.points} PTS, ${data.home_team.top_player.fg_percentage.toFixed(1)}% FG`;
                }

                // Populate away team stats
                populateTeamTable('away-team-table', data.away_team);

                // Populate home team stats
                populateTeamTable('home-team-table', data.home_team);

                // Create shooting chart
                createShootingChart(data);
            })
            .catch(error => {
                console.error('Error loading box score:', error);
                document.querySelectorAll('.loading-message').forEach(el => {
                    el.textContent = 'Failed to load stats. Please try again.';
                    el.classList.add('error-message');
                });
            });
    }

    function populateTeamTable(tableId, teamData) {
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        // Add player rows
        teamData.players.forEach(player => {
            const row = document.createElement('tr');
            const stats = player.stats;
            // Calculate total field goals from 2pt and 3pt
            const fgMade = (stats.fg2m || 0) + (stats.fg3m || 0);
            const fgAttempted = (stats.fg2a || 0) + (stats.fg3a || 0);
            
            row.innerHTML = `
                <td>${player.name}</td>
                <td>-</td>
                <td>${stats.points || 0}</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>${fgMade}/${fgAttempted}</td>
                <td>${stats.fg3m || 0}/${stats.fg3a || 0}</td>
                <td>${stats.ftm || 0}/${stats.fta || 0}</td>
                <td>-</td>
                <td>${stats.fouls || 0}</td>
            `;
            tbody.appendChild(row);
        });

        // Add team totals
        const totals = teamData.stats;
        const tfoot = document.getElementById(tableId === 'away-team-table' ? 'away-team-totals' : 'home-team-totals');
        
        // Calculate totals from player stats
        let totalPoints = 0;
        let totalFouls = 0;
        let totalFGM = 0;
        let totalFGA = 0;
        let total3PM = 0;
        let total3PA = 0;
        let totalFTM = 0;
        let totalFTA = 0;
        
        teamData.players.forEach(player => {
            const stats = player.stats;
            totalPoints += stats.points || 0;
            totalFouls += stats.fouls || 0;
            totalFGM += (stats.fg2m || 0) + (stats.fg3m || 0);
            totalFGA += (stats.fg2a || 0) + (stats.fg3a || 0);
            total3PM += stats.fg3m || 0;
            total3PA += stats.fg3a || 0;
            totalFTM += stats.ftm || 0;
            totalFTA += stats.fta || 0;
        });
        
        tfoot.innerHTML = `
            <tr>
                <td><strong>Team Totals</strong></td>
                <td>-</td>
                <td><strong>${totalPoints}</strong></td>
                <td><strong>-</strong></td>
                <td><strong>-</strong></td>
                <td><strong>-</strong></td>
                <td><strong>-</strong></td>
                <td><strong>${totalFGM}/${totalFGA}</strong></td>
                <td><strong>${total3PM}/${total3PA}</strong></td>
                <td><strong>${totalFTM}/${totalFTA}</strong></td>
                <td><strong>-</strong></td>
                <td><strong>${totalFouls}</strong></td>
            </tr>
        `;
    }

    function createShootingChart(data) {
        const ctx = document.getElementById('shooting-chart').getContext('2d');

        // Extract shooting data
        const awayTeam = data.away_team;
        const homeTeam = data.home_team;
        
        // Calculate percentages from player stats
        let awayFGM = 0, awayFGA = 0, away3PM = 0, away3PA = 0, awayFTM = 0, awayFTA = 0;
        let homeFGM = 0, homeFGA = 0, home3PM = 0, home3PA = 0, homeFTM = 0, homeFTA = 0;
        
        awayTeam.players.forEach(player => {
            const stats = player.stats;
            awayFGM += (stats.fg2m || 0) + (stats.fg3m || 0);
            awayFGA += (stats.fg2a || 0) + (stats.fg3a || 0);
            away3PM += stats.fg3m || 0;
            away3PA += stats.fg3a || 0;
            awayFTM += stats.ftm || 0;
            awayFTA += stats.fta || 0;
        });
        
        homeTeam.players.forEach(player => {
            const stats = player.stats;
            homeFGM += (stats.fg2m || 0) + (stats.fg3m || 0);
            homeFGA += (stats.fg2a || 0) + (stats.fg3a || 0);
            home3PM += stats.fg3m || 0;
            home3PA += stats.fg3a || 0;
            homeFTM += stats.ftm || 0;
            homeFTA += stats.fta || 0;
        });

        const awayFG = awayFGA > 0 ? (awayFGM / awayFGA * 100) : 0;
        const away3PT = away3PA > 0 ? (away3PM / away3PA * 100) : 0;
        const awayFT = awayFTA > 0 ? (awayFTM / awayFTA * 100) : 0;

        const homeFG = homeFGA > 0 ? (homeFGM / homeFGA * 100) : 0;
        const home3PT = home3PA > 0 ? (home3PM / home3PA * 100) : 0;
        const homeFT = homeFTA > 0 ? (homeFTM / homeFTA * 100) : 0;

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['FG%', '3PT%', 'FT%'],
                datasets: [
                    {
                        label: awayTeam.name,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        data: [awayFG, away3PT, awayFT]
                    },
                    {
                        label: homeTeam.name,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        data: [homeFG, home3PT, homeFT]
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Shooting Percentages'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.raw.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Percentage (%)'
                        }
                    }
                }
            }
        });
    }

    function formatDate(dateString) {
        // Parse date string as local date, not UTC
        // For YYYY-MM-DD format, split and create date with local timezone
        const [year, month, day] = dateString.split('-').map(num => parseInt(num, 10));
        const date = new Date(year, month - 1, day); // month is 0-indexed
        return date.toLocaleDateString(undefined, {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
</script>
{% endblock %}

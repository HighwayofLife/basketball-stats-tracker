{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="game-header">
    <div id="game-info">
        <!-- Game info will be populated via JavaScript -->
        <p class="loading-message">Loading game information...</p>
    </div>
</div>

<div class="game-content-grid">
    <div class="main-content">
        <div class="card">
        <h2>Box Score</h2>
        <div class="tab-container">
            <div class="tabs">
                <button class="tab-btn active" data-tab="away-team" id="away-team-tab">Away Team</button>
                <button class="tab-btn" data-tab="home-team" id="home-team-tab">Home Team</button>
            </div>

            <div class="tab-content active" id="away-team">
                <h3 id="away-team-name">Away Team</h3>
                <table class="data-table games-table mobile-table-view" id="away-team-table">
                    <thead>
                        <tr>
                            <th class="jersey-col"></th>
                            <th>Player</th>
                            <th class="stat-col">Pts</th>
                            <th class="stat-col">FG</th>
                            <th class="stat-col">3Pt</th>
                            <th class="stat-col">FT</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="loading-message">Loading player stats...</td>
                        </tr>
                    </tbody>
                    <tfoot id="away-team-totals">
                        <!-- Team totals will be populated via JavaScript -->
                    </tfoot>
                </table>
            </div>

            <div class="tab-content" id="home-team">
                <h3 id="home-team-name">Home Team</h3>
                <table class="data-table games-table mobile-table-view" id="home-team-table">
                    <thead>
                        <tr>
                            <th class="jersey-col"></th>
                            <th>Player</th>
                            <th class="stat-col">Pts</th>
                            <th class="stat-col">FG</th>
                            <th class="stat-col">3Pt</th>
                            <th class="stat-col">FT</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="loading-message">Loading player stats...</td>
                        </tr>
                    </tbody>
                    <tfoot id="home-team-totals">
                        <!-- Team totals will be populated via JavaScript -->
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

        <div class="card">
            <h2>Shooting Chart</h2>
            <div class="chart-container">
                <canvas id="shooting-chart"></canvas>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card" id="top-players-card">
            <h2>Game Leaders</h2>
            <div class="top-players-container">
                <div class="top-player-box away-player" id="away-player-1">
                    <div class="player-photo-placeholder">
                        <svg width="50" height="50" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="30" cy="30" r="30" fill="#E5E7EB"/>
                            <path d="M30 32C34.4183 32 38 28.4183 38 24C38 19.5817 34.4183 16 30 16C25.5817 16 22 19.5817 22 24C22 28.4183 25.5817 32 30 32Z" fill="#9CA3AF"/>
                            <path d="M30 36C21.1634 36 14 43.1634 14 52V60H46V52C46 43.1634 38.8366 36 30 36Z" fill="#9CA3AF"/>
                        </svg>
                    </div>
                    <div class="player-info">
                        <h3 class="team-name" id="away-top-team-name-1">Away Team</h3>
                        <p class="player-name" id="away-top-player-name-1">-</p>
                        <p class="player-stats" id="away-top-player-stats-1">-</p>
                    </div>
                </div>
                <div class="top-player-box home-player" id="home-player-1">
                    <div class="player-photo-placeholder">
                        <svg width="50" height="50" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="30" cy="30" r="30" fill="#E5E7EB"/>
                            <path d="M30 32C34.4183 32 38 28.4183 38 24C38 19.5817 34.4183 16 30 16C25.5817 16 22 19.5817 22 24C22 28.4183 25.5817 32 30 32Z" fill="#9CA3AF"/>
                            <path d="M30 36C21.1634 36 14 43.1634 14 52V60H46V52C46 43.1634 38.8366 36 30 36Z" fill="#9CA3AF"/>
                        </svg>
                    </div>
                    <div class="player-info">
                        <h3 class="team-name" id="home-top-team-name-1">Home Team</h3>
                        <p class="player-name" id="home-top-player-name-1">-</p>
                        <p class="player-stats" id="home-top-player-stats-1">-</p>
                    </div>
                </div>
                <div class="top-player-box away-player" id="away-player-2">
                    <div class="player-photo-placeholder">
                        <svg width="50" height="50" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="30" cy="30" r="30" fill="#E5E7EB"/>
                            <path d="M30 32C34.4183 32 38 28.4183 38 24C38 19.5817 34.4183 16 30 16C25.5817 16 22 19.5817 22 24C22 28.4183 25.5817 32 30 32Z" fill="#9CA3AF"/>
                            <path d="M30 36C21.1634 36 14 43.1634 14 52V60H46V52C46 43.1634 38.8366 36 30 36Z" fill="#9CA3AF"/>
                        </svg>
                    </div>
                    <div class="player-info">
                        <h3 class="team-name" id="away-top-team-name-2">Away Team</h3>
                        <p class="player-name" id="away-top-player-name-2">-</p>
                        <p class="player-stats" id="away-top-player-stats-2">-</p>
                    </div>
                </div>
                <div class="top-player-box home-player" id="home-player-2">
                    <div class="player-photo-placeholder">
                        <svg width="50" height="50" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="30" cy="30" r="30" fill="#E5E7EB"/>
                            <path d="M30 32C34.4183 32 38 28.4183 38 24C38 19.5817 34.4183 16 30 16C25.5817 16 22 19.5817 22 24C22 28.4183 25.5817 32 30 32Z" fill="#9CA3AF"/>
                            <path d="M30 36C21.1634 36 14 43.1634 14 52V60H46V52C46 43.1634 38.8366 36 30 36Z" fill="#9CA3AF"/>
                        </svg>
                    </div>
                    <div class="player-info">
                        <h3 class="team-name" id="home-top-team-name-2">Home Team</h3>
                        <p class="player-name" id="home-top-player-name-2">-</p>
                        <p class="player-stats" id="home-top-player-stats-2">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Get game ID from server context
    const gameId = {{ game_id }};

    document.addEventListener('DOMContentLoaded', function() {
        // Load game information and box score
        Promise.all([
            fetch(`/v1/games/${gameId}`),
            fetch(`/v1/games/${gameId}/box-score`)
        ])
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(([game, boxScore]) => {
            // Create scoreboard header
            createScoreboard(game, boxScore);

            // Load box score data
            loadBoxScoreData(boxScore);
        })
        .catch(error => {
            console.error('Error loading game data:', error);
            document.getElementById('game-info').innerHTML = `
                <p class="error-message">Failed to load game information. Please try again.</p>
            `;
        });

        // Set up tab switching
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');

                // Update active tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(this.dataset.tab).classList.add('active');
            });
        });
    });

    function createScoreboard(game, boxScore) {
        const awayTeam = boxScore.away_team;
        const homeTeam = boxScore.home_team;
        const awayQuarters = awayTeam.stats.quarter_scores || [];
        const homeQuarters = homeTeam.stats.quarter_scores || [];
        const awayRecord = awayTeam.record || '0-0';
        const homeRecord = homeTeam.record || '0-0';

        document.getElementById('game-info').innerHTML = `
            <div class="scoreboard">
                <div class="team-info">
                    <div class="team-section away-team">
                        <div class="team-header-with-logo">
                            <div class="team-logo-large" data-team-id="${awayTeam.team_id}"></div>
                            <div class="team-info-text">
                                <h2 class="team-name">${awayTeam.name}</h2>
                                <div class="team-record">(${awayRecord})</div>
                            </div>
                        </div>
                    </div>
                    <div class="score-section">
                        <div class="team-score away-score">${awayTeam.score}</div>
                        <div class="game-date-mobile">${formatDate(game.date)}</div>
                        <div class="team-score home-score">${homeTeam.score}</div>
                    </div>
                    <div class="team-section home-team">
                        <div class="team-header-with-logo">
                            <div class="team-info-text">
                                <h2 class="team-name">${homeTeam.name}</h2>
                                <div class="team-record">(${homeRecord})</div>
                            </div>
                            <div class="team-logo-large" data-team-id="${homeTeam.team_id}"></div>
                        </div>
                    </div>
                </div>

                <table class="quarter-scores-table">
                    <thead>
                        <tr id="quarter-headers">
                            <th>Team</th>
                            ${awayQuarters.map(q => `<th>${q.label}</th>`).join('')}
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="quarter-scores-body">
                        <tr>
                            <td data-label="Team" class="team-name-cell">${awayTeam.name}</td>
                            ${awayQuarters.map(q => `<td data-label="${q.label}">${q.score}</td>`).join('')}
                            <td data-label="Total" class="total-score">${awayTeam.score}</td>
                        </tr>
                        <tr>
                            <td data-label="Team" class="team-name-cell">${homeTeam.name}</td>
                            ${homeQuarters.map(q => `<td data-label="${q.label}">${q.score}</td>`).join('')}
                            <td data-label="Total" class="total-score">${homeTeam.score}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="game-date desktop-date">${formatDate(game.date)}</div>
            </div>
        `;
    }


    function loadBoxScoreData(data) {
        // Update team names in headers and tabs
        document.getElementById('away-team-name').textContent = data.away_team.name;
        document.getElementById('home-team-name').textContent = data.home_team.name;
        document.getElementById('away-team-tab').textContent = data.away_team.name;
        document.getElementById('home-team-tab').textContent = data.home_team.name;

        // Update top players section
        function updatePlayerBox(player, teamName, playerIndex, teamType) {
            if (!player) {
                // Hide the player box if no player data
                const playerBox = document.getElementById(`${teamType}-player-${playerIndex}`);
                if (playerBox) {
                    playerBox.style.display = 'none';
                }
                return;
            }
            
            const fgMade = (player.fg2m || 0) + (player.fg3m || 0);
            const fgAttempted = (player.fg2a || 0) + (player.fg3a || 0);
            const fg3Percentage = (player.fg3a > 0) ? ((player.fg3m || 0) / player.fg3a * 100).toFixed(1) : '0.0';
            
            document.getElementById(`${teamType}-top-team-name-${playerIndex}`).textContent = teamName;
            document.getElementById(`${teamType}-top-player-name-${playerIndex}`).textContent = player.name;
            document.getElementById(`${teamType}-top-player-stats-${playerIndex}`).innerHTML =
                `${player.points} PTS, ${fgMade}/${fgAttempted} FG (${player.fg_percentage.toFixed(1)}%)<br>` +
                `${player.fg3m || 0}/${player.fg3a || 0} 3PT (${fg3Percentage}%)`;
            
            // Update player photo
            const playerBox = document.getElementById(`${teamType}-player-${playerIndex}`);
            if (playerBox) {
                const photoPlaceholder = playerBox.querySelector('.player-photo-placeholder');
                if (photoPlaceholder && player.thumbnail_image) {
                    const portraitUrl = `/uploads/${player.thumbnail_image}`;
                    photoPlaceholder.innerHTML = `<img src="${portraitUrl}" alt="${player.name}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">`;
                }
            }
        }

        // Update away team players (top 2)
        const awayTopPlayers = data.away_team.top_players || [];
        updatePlayerBox(awayTopPlayers[0], data.away_team.name, 1, 'away');
        updatePlayerBox(awayTopPlayers[1], data.away_team.name, 2, 'away');

        // Update home team players (top 2)
        const homeTopPlayers = data.home_team.top_players || [];
        updatePlayerBox(homeTopPlayers[0], data.home_team.name, 1, 'home');
        updatePlayerBox(homeTopPlayers[1], data.home_team.name, 2, 'home');

        // Populate away team stats
        populateTeamTable('away-team-table', data.away_team);

        // Populate home team stats
        populateTeamTable('home-team-table', data.home_team);

        // Create shooting chart
        createShootingChart(data);
        
        // Load team logos
        loadTeamLogosForGameDetail();
    }

    function populateTeamTable(tableId, teamData) {
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        // Add player rows
        teamData.players.forEach(player => {
            const row = document.createElement('tr');
            const stats = player.stats;
            // Calculate total field goals from 2pt and 3pt
            const fgMade = (stats.fg2m || 0) + (stats.fg3m || 0);
            const fgAttempted = (stats.fg2a || 0) + (stats.fg3a || 0);
            
            // Get player position if available
            const position = player.position ? ` Â· ${player.position}` : '';

            // Calculate percentages
            const fgPercentage = fgAttempted > 0 ? ((fgMade / fgAttempted) * 100).toFixed(1) : '0.0';
            const fg3Percentage = (stats.fg3a || 0) > 0 ? (((stats.fg3m || 0) / stats.fg3a) * 100).toFixed(1) : '0.0';
            const ftPercentage = (stats.fta || 0) > 0 ? (((stats.ftm || 0) / stats.fta) * 100).toFixed(1) : '0.0';

            row.innerHTML = `
                <td class="jersey-number">${player.jersey_number || '-'}</td>
                <td class="player-name" data-label="Player">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        ${getPlayerPortraitTiny(player)}
                        <a href="/players/${player.player_id}" class="player-link">${player.name}${position}</a>
                    </div>
                </td>
                <td data-label="Pts">${stats.points || 0}</td>
                <td data-label="FG">${fgMade}-${fgAttempted}<span class="shooting-percentage">(${fgPercentage}%)</span></td>
                <td data-label="3Pt">${stats.fg3m || 0}-${stats.fg3a || 0}<span class="shooting-percentage">(${fg3Percentage}%)</span></td>
                <td data-label="FT">${stats.ftm || 0}-${stats.fta || 0}<span class="shooting-percentage">(${ftPercentage}%)</span></td>
            `;
            tbody.appendChild(row);
        });

        // Add team totals
        const tfoot = document.getElementById(tableId === 'away-team-table' ? 'away-team-totals' : 'home-team-totals');

        // Calculate totals from player stats
        let totalPoints = 0;
        let totalFGM = 0;
        let totalFGA = 0;
        let total3PM = 0;
        let total3PA = 0;
        let totalFTM = 0;
        let totalFTA = 0;

        teamData.players.forEach(player => {
            const stats = player.stats;
            totalPoints += stats.points || 0;
            totalFGM += (stats.fg2m || 0) + (stats.fg3m || 0);
            totalFGA += (stats.fg2a || 0) + (stats.fg3a || 0);
            total3PM += stats.fg3m || 0;
            total3PA += stats.fg3a || 0;
            totalFTM += stats.ftm || 0;
            totalFTA += stats.fta || 0;
        });

        // Calculate team percentages
        const teamFGPercentage = totalFGA > 0 ? ((totalFGM / totalFGA) * 100).toFixed(1) : '0.0';
        const team3PPercentage = total3PA > 0 ? ((total3PM / total3PA) * 100).toFixed(1) : '0.0';
        const teamFTPercentage = totalFTA > 0 ? ((totalFTM / totalFTA) * 100).toFixed(1) : '0.0';

        tfoot.innerHTML = `
            <tr>
                <td></td>
                <td><strong>Team Totals</strong></td>
                <td><strong>${totalPoints}</strong></td>
                <td><strong>${totalFGM}-${totalFGA}<span class="shooting-percentage">(${teamFGPercentage}%)</span></strong></td>
                <td><strong>${total3PM}-${total3PA}<span class="shooting-percentage">(${team3PPercentage}%)</span></strong></td>
                <td><strong>${totalFTM}-${totalFTA}<span class="shooting-percentage">(${teamFTPercentage}%)</span></strong></td>
            </tr>
        `;
    }

    function getPlayerPortraitTiny(player) {
        // For the box score, we want very small portraits
        return `<div class="player-portrait-tiny">
                    <i class="fas fa-user"></i>
                </div>`;
    }

    function createShootingChart(data) {
        const ctx = document.getElementById('shooting-chart').getContext('2d');

        // Extract shooting data
        const awayTeam = data.away_team;
        const homeTeam = data.home_team;

        // Calculate percentages from player stats
        let awayFGM = 0, awayFGA = 0, away2PM = 0, away2PA = 0, away3PM = 0, away3PA = 0, awayFTM = 0, awayFTA = 0;
        let homeFGM = 0, homeFGA = 0, home2PM = 0, home2PA = 0, home3PM = 0, home3PA = 0, homeFTM = 0, homeFTA = 0;
        let awayPoints = 0, homePoints = 0;

        awayTeam.players.forEach(player => {
            const stats = player.stats;
            away2PM += stats.fg2m || 0;
            away2PA += stats.fg2a || 0;
            away3PM += stats.fg3m || 0;
            away3PA += stats.fg3a || 0;
            awayFGM += (stats.fg2m || 0) + (stats.fg3m || 0);
            awayFGA += (stats.fg2a || 0) + (stats.fg3a || 0);
            awayFTM += stats.ftm || 0;
            awayFTA += stats.fta || 0;
            awayPoints += stats.points || 0;
        });

        homeTeam.players.forEach(player => {
            const stats = player.stats;
            home2PM += stats.fg2m || 0;
            home2PA += stats.fg2a || 0;
            home3PM += stats.fg3m || 0;
            home3PA += stats.fg3a || 0;
            homeFGM += (stats.fg2m || 0) + (stats.fg3m || 0);
            homeFGA += (stats.fg2a || 0) + (stats.fg3a || 0);
            homeFTM += stats.ftm || 0;
            homeFTA += stats.fta || 0;
            homePoints += stats.points || 0;
        });

        // Calculate basic percentages
        const awayFG = awayFGA > 0 ? (awayFGM / awayFGA * 100) : 0;
        const away2PT = away2PA > 0 ? (away2PM / away2PA * 100) : 0;
        const away3PT = away3PA > 0 ? (away3PM / away3PA * 100) : 0;
        const awayFT = awayFTA > 0 ? (awayFTM / awayFTA * 100) : 0;

        const homeFG = homeFGA > 0 ? (homeFGM / homeFGA * 100) : 0;
        const home2PT = home2PA > 0 ? (home2PM / home2PA * 100) : 0;
        const home3PT = home3PA > 0 ? (home3PM / home3PA * 100) : 0;
        const homeFT = homeFTA > 0 ? (homeFTM / homeFTA * 100) : 0;

        // Calculate advanced metrics
        // eFG% = (FGM + 0.5 * 3PM) / FGA
        const awayEFG = awayFGA > 0 ? ((awayFGM + 0.5 * away3PM) / awayFGA * 100) : 0;
        const homeEFG = homeFGA > 0 ? ((homeFGM + 0.5 * home3PM) / homeFGA * 100) : 0;

        // TS% = Points / (2 * (FGA + 0.44 * FTA))
        const awayTSA = 2 * (awayFGA + 0.44 * awayFTA);
        const awayTS = awayTSA > 0 ? (awayPoints / awayTSA * 100) : 0;
        const homeTSA = 2 * (homeFGA + 0.44 * homeFTA);
        const homeTS = homeTSA > 0 ? (homePoints / homeTSA * 100) : 0;

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['FG%', '2PT%', '3PT%', 'FT%', 'eFG%', 'TS%'],
                datasets: [
                    {
                        label: awayTeam.name,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        data: [awayFG, away2PT, away3PT, awayFT, awayEFG, awayTS]
                    },
                    {
                        label: homeTeam.name,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        data: [homeFG, home2PT, home3PT, homeFT, homeEFG, homeTS]
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Shooting Percentages'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.raw.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Percentage (%)'
                        }
                    }
                }
            }
        });
    }

    function formatDate(dateString) {
        // Parse date string as local date, not UTC
        // For YYYY-MM-DD format, split and create date with local timezone
        const [year, month, day] = dateString.split('-').map(num => parseInt(num, 10));
        const date = new Date(year, month - 1, day); // month is 0-indexed
        return date.toLocaleDateString(undefined, {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    async function loadTeamLogosForGameDetail() {
        // Get all team logo containers
        const logoContainers = document.querySelectorAll('.team-logo-large');
        
        // Create a set of unique team IDs to avoid duplicate requests
        const teamIds = new Set();
        logoContainers.forEach(container => {
            const teamId = container.getAttribute('data-team-id');
            if (teamId && teamId !== '') {
                teamIds.add(teamId);
            }
        });

        // Check if logos exist for each unique team ID
        const logoCache = {};
        await Promise.all([...teamIds].map(async (teamId) => {
            try {
                // Try multiple logo file formats
                const formats = ['png', 'jpg', 'jpeg', 'webp'];
                let logoUrl = null;
                
                for (const format of formats) {
                    const testUrl = `/uploads/teams/${teamId}/logo.${format}`;
                    try {
                        const response = await fetch(testUrl, { method: 'HEAD' });
                        if (response.ok) {
                            logoUrl = testUrl;
                            break;
                        }
                    } catch (e) {
                        // Continue to next format
                    }
                }
                
                logoCache[teamId] = logoUrl;
            } catch (error) {
                console.warn(`Failed to check logo for team ${teamId}:`, error);
                logoCache[teamId] = null;
            }
        }));

        // Apply logos to containers
        logoContainers.forEach(container => {
            const teamId = container.getAttribute('data-team-id');
            if (teamId && teamId !== '') {
                const logoUrl = logoCache[teamId];
                
                if (logoUrl) {
                    container.innerHTML = `<img src="${logoUrl}" alt="Team logo" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-users\\'></i>'">`;
                } else {
                    container.innerHTML = '<i class="fas fa-users"></i>';
                }
            } else {
                container.innerHTML = '<i class="fas fa-users"></i>';
            }
        });
    }

    // Helper function to get tiny player portrait HTML for box scores
    function getPlayerPortraitTiny(player) {
        // Construct portrait URL from thumbnail_image field
        const portraitUrl = player.thumbnail_image ? `/uploads/${player.thumbnail_image}` : null;
        
        if (portraitUrl && portraitUrl !== 'None') {
            return `<img class="rounded-circle"
                         src="${portraitUrl}"
                         alt="${player.name}"
                         style="width: 32px; height: 32px; object-fit: cover;"
                         onerror="this.onerror=null; this.outerHTML='<div class=\\'rounded-circle bg-light d-flex align-items-center justify-content-center\\' style=\\'width: 32px; height: 32px;\\'><i class=\\'fas fa-user text-muted\\' style=\\'font-size: 14px;\\'></i></div>';">`;                
        } else {
            return `<div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                        <i class="fas fa-user text-muted" style="font-size: 14px;"></i>
                    </div>`;
        }
    }
</script>
{% endblock %}

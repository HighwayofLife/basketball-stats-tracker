{% extends "base.html" %}

{% block title %}Scorebook Entry{% endblock %}

{% block head %}
<style>
    .jersey-input {
        background-color: #fffbf0;
        border: 2px solid #ffc107;
    }
    .jersey-input:focus {
        border-color: #ff9800;
        box-shadow: 0 0 0 0.2rem rgba(255, 152, 0, 0.25);
    }
    .jersey-input.is-invalid {
        border-color: #dc3545;
        background-color: #fff5f5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0" id="pageTitle">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span id="pageTitleText">Scorebook Entry</span>
                </h1>
                <div>
                    <button type="button" class="btn btn-outline-primary me-2" onclick="document.getElementById('csvFileInput').click()">
                        <i class="fas fa-file-import"></i> Import CSV
                    </button>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="clearForm()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveGame()" id="saveButton">
                        <i class="fas fa-save"></i> <span id="saveButtonText">Save Game</span>
                    </button>
                </div>
            </div>

            <!-- Game Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Game Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="homeTeam" class="form-label">Home Team</label>
                                <select class="form-select" id="homeTeam" required>
                                    <option value="">Select home team...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="awayTeam" class="form-label">Away Team</label>
                                <select class="form-select" id="awayTeam" required>
                                    <option value="">Select away team...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="gameDate" class="form-label">Game Date</label>
                                <input type="date" class="form-control" id="gameDate" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="location" class="form-label">Location (Optional)</label>
                                <input type="text" class="form-control" id="location" placeholder="Enter game location">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notes" class="form-label">Notes (Optional)</label>
                                <input type="text" class="form-control" id="notes" placeholder="Enter any notes">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scoring Notation Guide -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>
                        Scoring Notation Guide
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Shot Types:</h6>
                            <ul class="list-unstyled">
                                <li><code>1</code> = Made Free Throw</li>
                                <li><code>x</code> = Missed Free Throw</li>
                                <li><code>2</code> = Made 2-Point Shot</li>
                                <li><code>-</code> = Missed 2-Point Shot</li>
                                <li><code>3</code> = Made 3-Point Shot</li>
                                <li><code>/</code> = Missed 3-Point Shot</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Examples:</h6>
                            <ul class="list-unstyled">
                                <li><code>22-1x</code> = 2 made 2pts, 1 missed 2pt, 1 made FT, 1 missed FT</li>
                                <li><code>3/2</code> = 1 made 3pt, 1 missed 3pt, 1 made 2pt</li>
                                <li><code>11</code> = 2 made free throws</li>
                                <li><code>-/</code> = 1 missed 2pt, 1 missed 3pt</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>CSV Import Format:</h6>
                            <ul class="list-unstyled small">
                                <li>Use the <strong>Import CSV</strong> button to load game data</li>
                                <li>CSV must include game info and player stats</li>
                                <li>Headers: <code>Team Name</code>, <code>Player Jersey</code>, <code>Player Name</code>, <code>Fouls</code>, <code>QT1-4 Shots</code></li>
                                <li><a href="/static/game_stats_template.csv" download class="text-primary">Download Template CSV</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Player Stats Entry -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Player Statistics</h5>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addPlayerRow()">
                        <i class="fas fa-plus"></i> Add Player
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="playerStatsTable">
                            <thead>
                                <tr>
                                    <th style="width: 200px;">Player Name</th>
                                    <th style="width: 100px;">Team</th>
                                    <th style="width: 80px;">Jersey #</th>
                                    <th style="width: 80px;">Fouls</th>
                                    <th style="width: 150px;">Q1 Scoring</th>
                                    <th style="width: 150px;">Q2 Scoring</th>
                                    <th style="width: 150px;">Q3 Scoring</th>
                                    <th style="width: 150px;">Q4 Scoring</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="playerStatsBody">
                                <!-- Player rows will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-muted mt-3">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            Enter scoring using the notation guide above. Players from both teams can be mixed in any order.
                        </small>
                    </div>
                </div>
            </div>

            <!-- Game Summary -->
            <div class="card mt-4" id="gameSummary" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Game Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 id="homeTeamSummary">Home Team: 0</h6>
                            <div id="homeTeamStats"></div>
                        </div>
                        <div class="col-md-6">
                            <h6 id="awayTeamSummary">Away Team: 0</h6>
                            <div id="awayTeamStats"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Player Row Template -->
<template id="playerRowTemplate">
    <tr class="player-row">
        <td>
            <select class="form-select player-select" onchange="updatePlayerInfo(this)" required>
                <option value="">Select player...</option>
            </select>
        </td>
        <td>
            <span class="team-display text-muted">-</span>
        </td>
        <td>
            <span class="jersey-display text-muted">-</span>
        </td>
        <td>
            <input type="number" class="form-control fouls-input" min="0" max="10" value="0" 
                   onchange="updateGameSummary()">
        </td>
        <td>
            <input type="text" class="form-control scoring-input" placeholder="e.g., 22-1x" 
                   onchange="updateGameSummary()">
        </td>
        <td>
            <input type="text" class="form-control scoring-input" placeholder="e.g., 3/2" 
                   onchange="updateGameSummary()">
        </td>
        <td>
            <input type="text" class="form-control scoring-input" placeholder="e.g., 11" 
                   onchange="updateGameSummary()">
        </td>
        <td>
            <input type="text" class="form-control scoring-input" placeholder="e.g., -/" 
                   onchange="updateGameSummary()">
        </td>
        <td>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-info substitute-toggle" 
                        onclick="toggleSubstitute(this)" 
                        title="Mark as substitute player"
                        style="display: none;">
                    <i class="fas fa-exchange-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="removePlayerRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    </tr>
</template>

<style>
.scoring-input {
    font-family: 'Courier New', monospace;
    text-align: center;
}

.jersey-display, .team-display {
    font-weight: 500;
}

.table th {
    background-color: #f8f9fa;
    border-top: none;
    position: sticky;
    top: 0;
    z-index: 10;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

code {
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 600;
}

.btn-group-sm > .btn, .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.table-responsive {
    max-height: 500px;
    overflow-y: auto;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.85rem;
    }
    
    .scoring-input {
        min-width: 80px;
    }
}

.substitute-toggle {
    font-size: 0.75rem;
    padding: 0.2rem 0.4rem;
}

.btn-info {
    background-color: #17a2b8;
    border-color: #17a2b8;
    color: white;
}

.text-info {
    color: #17a2b8 !important;
}
</style>

<script>
let teamsData = [];
let playersData = [];
let substitutePlayerNames = []; // List of known substitute player names

// Initialize the page
document.addEventListener('DOMContentLoaded', async function() {
    setDefaultDate();
    await loadTeamsAndPlayers();
    await loadSubstitutePlayerNames();
    
    // Check if we're in edit mode (game_id provided in URL)
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('game_id');
    
    if (gameId) {
        // Load existing game data
        await loadGameForEdit(gameId);
    } else {
        // Only add the first row if we successfully loaded data
        if (teamsData && teamsData.length > 0) {
            addPlayerRow(); // Add first row by default
        }
    }
});

function setDefaultDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('gameDate').value = today;
}

async function loadTeamsAndPlayers() {
    try {
        // Load teams
        const teamsResponse = await fetch('/v1/teams/detail');
        if (!teamsResponse.ok) {
            throw new Error(`Failed to load teams: ${teamsResponse.status}`);
        }
        teamsData = await teamsResponse.json();
        
        // Load players
        const playersResponse = await fetch('/v1/players/list');
        if (!playersResponse.ok) {
            throw new Error(`Failed to load players: ${playersResponse.status}`);
        }
        playersData = await playersResponse.json();
        
        // Check if we have data
        if (!teamsData || teamsData.length === 0) {
            showAlert('No teams found. Please create teams first before entering game data.', 'warning');
            // Disable form controls when no teams
            document.getElementById('homeTeam').disabled = true;
            document.getElementById('awayTeam').disabled = true;
            document.querySelector('button[onclick="saveGame()"]').disabled = true;
            document.querySelector('button[onclick="addPlayerRow()"]').disabled = true;
            return;
        }
        
        if (!playersData || playersData.length === 0) {
            showAlert('No players found. You can still create a game and players will be created automatically when you import or save.', 'info');
        }
        
        populateTeamSelects();
        
    } catch (error) {
        console.error('Error loading teams and players:', error);
        showAlert('Unable to load teams and players. The database may be empty or unavailable. Please try again later.', 'danger');
        // Disable form controls on error
        document.getElementById('homeTeam').disabled = true;
        document.getElementById('awayTeam').disabled = true;
        document.querySelector('button[onclick="saveGame()"]').disabled = true;
        document.querySelector('button[onclick="addPlayerRow()"]').disabled = true;
    }
}

async function loadSubstitutePlayerNames() {
    try {
        // Load substitute players from the database
        // Get all players that are marked as substitutes
        const substitutePlayers = playersData.filter(player => player.is_substitute);
        
        // Extract their names for matching during CSV import
        substitutePlayerNames = substitutePlayers.map(player => player.name.toLowerCase());
        
        // Make it available globally for CSV import
        window.substitutePlayerNames = substitutePlayerNames;
        window.substitutePlayers = substitutePlayers;
    } catch (error) {
        console.error('Error loading substitute player names:', error);
        substitutePlayerNames = [];
        window.substitutePlayerNames = [];
    }
}

async function loadGameForEdit(gameId) {
    try {
        // Update page title and save button
        document.getElementById('pageTitleText').textContent = 'Edit Game';
        document.getElementById('saveButtonText').textContent = 'Update Game';
        
        // Fetch game data in scorebook format
        const response = await fetch(`/v1/games/${gameId}/scorebook-format`);
        if (!response.ok) {
            const error = await response.json();
            showAlert(`Error loading game: ${error.detail}`, 'danger');
            return;
        }
        
        const gameData = await response.json();
        
        // Set game information
        document.getElementById('gameDate').value = gameData.game_info.date;
        document.getElementById('homeTeam').value = gameData.game_info.home_team_id;
        document.getElementById('awayTeam').value = gameData.game_info.away_team_id;
        document.getElementById('location').value = gameData.game_info.location || '';
        document.getElementById('notes').value = gameData.game_info.notes || '';
        
        // Clear existing player rows
        document.getElementById('playerStatsBody').innerHTML = '';
        
        // Add player rows with existing data
        gameData.player_stats.forEach(playerStat => {
            addPlayerRow();
            const lastRow = document.querySelector('#playerStatsBody tr:last-child');
            
            if (lastRow) {
                // Set player selection
                const playerSelect = lastRow.querySelector('.player-select');
                playerSelect.value = playerStat.player_id;
                updatePlayerInfo(playerSelect);
                
                // Set fouls
                const foulsInput = lastRow.querySelector('.fouls-input');
                foulsInput.value = playerStat.fouls;
                
                // Set quarter shots
                const scoringInputs = lastRow.querySelectorAll('.scoring-input');
                scoringInputs[0].value = playerStat.shots_q1 || '';
                scoringInputs[1].value = playerStat.shots_q2 || '';
                scoringInputs[2].value = playerStat.shots_q3 || '';
                scoringInputs[3].value = playerStat.shots_q4 || '';
            }
        });
        
        // Update game summary
        updateGameSummary();
        
        showAlert('Game loaded for editing', 'info');
        
    } catch (error) {
        console.error('Error loading game for edit:', error);
        showAlert('Error loading game data. Please try again.', 'danger');
    }
}

function populateTeamSelects() {
    const homeTeamSelect = document.getElementById('homeTeam');
    const awayTeamSelect = document.getElementById('awayTeam');
    
    // Clear existing options except the first one
    homeTeamSelect.innerHTML = '<option value="">Select home team...</option>';
    awayTeamSelect.innerHTML = '<option value="">Select away team...</option>';
    
    teamsData.forEach(team => {
        const option1 = new Option(team.name, team.id);
        const option2 = new Option(team.name, team.id);
        homeTeamSelect.add(option1);
        awayTeamSelect.add(option2);
    });
}

function addPlayerRow() {
    const template = document.getElementById('playerRowTemplate');
    const clone = template.content.cloneNode(true);
    const playerSelect = clone.querySelector('.player-select');
    
    // Populate player options
    playerSelect.innerHTML = '<option value="">Select player...</option>';
    
    // Only add player options if we have players
    if (playersData && playersData.length > 0) {
        playersData.forEach(player => {
            const displayName = player.is_substitute 
                ? `🔄 ${player.name} (#${player.jersey_number}) - ${player.team_name} [SUB]`
                : `${player.name} (#${player.jersey_number}) - ${player.team_name}`;
            const option = new Option(displayName, player.id);
            option.dataset.teamId = player.team_id;
            option.dataset.teamName = player.team_name;
            option.dataset.jerseyNumber = player.jersey_number;
            option.dataset.isSubstitute = player.is_substitute || false;
            if (player.is_substitute) {
                option.classList.add('text-info');
            }
            playerSelect.add(option);
        });
    } else {
        // Add a helpful message if no players exist
        const option = new Option('No players available - Import CSV to create players', '');
        option.disabled = true;
        playerSelect.add(option);
    }
    
    document.getElementById('playerStatsBody').appendChild(clone);
}

function removePlayerRow(button) {
    const row = button.closest('tr');
    row.remove();
    updateGameSummary();
}

function updatePlayerInfo(select) {
    const row = select.closest('tr');
    const selectedOption = select.options[select.selectedIndex];
    const substituteToggle = row.querySelector('.substitute-toggle');
    
    if (selectedOption.value) {
        // If a player is selected, update displays
        row.querySelector('.team-display').textContent = selectedOption.dataset.teamName;
        
        // Handle jersey display - if it's an input (for new players), replace it with text
        const jerseyDisplay = row.querySelector('.jersey-display');
        if (jerseyDisplay) {
            const jerseyInput = jerseyDisplay.querySelector('.jersey-input');
            if (jerseyInput) {
                // Replace the input with the jersey number from the selected player
                jerseyDisplay.innerHTML = selectedOption.dataset.jerseyNumber;
            } else {
                jerseyDisplay.textContent = selectedOption.dataset.jerseyNumber;
            }
        }
        
        // Hide substitute toggle for existing players
        if (substituteToggle) {
            substituteToggle.style.display = 'none';
        }
        
        // If this row was marked as a new player, unmark it since a player is now selected
        if (row.dataset.newPlayer === 'true') {
            row.dataset.newPlayer = 'false';
            
            // Clean up the "NEW" prefix from the option text if it exists
            if (selectedOption.text.includes('⚠️ NEW:')) {
                // This was the placeholder option, update it to show the selected player
                const teamName = selectedOption.dataset.teamName || row.dataset.teamName;
                selectedOption.text = `${selectedOption.text.split(' (')[0].replace('⚠️ NEW:', '').trim()} - ${teamName}`;
                selectedOption.classList.remove('text-warning');
            }
        }
    } else {
        row.querySelector('.team-display').textContent = '-';
        row.querySelector('.jersey-display').textContent = '-';
        
        // Hide substitute toggle when no player selected
        if (substituteToggle) {
            substituteToggle.style.display = 'none';
        }
    }
    
    updateGameSummary();
}

function toggleSubstitute(button) {
    const row = button.closest('tr');
    const playerType = row.dataset.playerType;
    
    // Toggle between regular and substitute
    if (playerType === 'substitute') {
        row.dataset.playerType = 'regular';
        button.classList.remove('btn-info');
        button.classList.add('btn-outline-info');
        button.title = 'Mark as substitute player';
        
        // Update the display text
        const playerSelect = row.querySelector('.player-select');
        const selectedOption = playerSelect.options[playerSelect.selectedIndex];
        if (selectedOption && selectedOption.text.includes('🔄 SUB:')) {
            selectedOption.text = selectedOption.text.replace('🔄 SUB:', '⚠️ NEW:');
            selectedOption.classList.remove('text-info');
            selectedOption.classList.add('text-warning');
        }
    } else {
        row.dataset.playerType = 'substitute';
        button.classList.remove('btn-outline-info');
        button.classList.add('btn-info');
        button.title = 'Remove substitute designation';
        
        // Update the display text
        const playerSelect = row.querySelector('.player-select');
        const selectedOption = playerSelect.options[playerSelect.selectedIndex];
        if (selectedOption && selectedOption.text.includes('⚠️ NEW:')) {
            selectedOption.text = selectedOption.text.replace('⚠️ NEW:', '🔄 SUB:');
            selectedOption.classList.remove('text-warning');
            selectedOption.classList.add('text-info');
        }
    }
}

function updateGameSummary() {
    const homeTeamId = document.getElementById('homeTeam').value;
    const awayTeamId = document.getElementById('awayTeam').value;
    
    if (!homeTeamId || !awayTeamId) {
        document.getElementById('gameSummary').style.display = 'none';
        return;
    }
    
    const homeTeamName = document.getElementById('homeTeam').options[document.getElementById('homeTeam').selectedIndex].text;
    const awayTeamName = document.getElementById('awayTeam').options[document.getElementById('awayTeam').selectedIndex].text;
    
    let homeScore = 0;
    let awayScore = 0;
    let homeStats = { players: 0, fouls: 0 };
    let awayStats = { players: 0, fouls: 0 };
    
    // Calculate scores and stats for each player
    document.querySelectorAll('.player-row').forEach(row => {
        const playerSelect = row.querySelector('.player-select');
        const selectedOption = playerSelect.options[playerSelect.selectedIndex];
        
        if (selectedOption.value) {
            const teamId = selectedOption.dataset.teamId;
            const fouls = parseInt(row.querySelector('.fouls-input').value) || 0;
            
            // Calculate scoring for all quarters
            let playerScore = 0;
            row.querySelectorAll('.scoring-input').forEach(input => {
                playerScore += parseScoring(input.value);
            });
            
            if (teamId === homeTeamId) {
                homeScore += playerScore;
                homeStats.players++;
                homeStats.fouls += fouls;
            } else if (teamId === awayTeamId) {
                awayScore += playerScore;
                awayStats.players++;
                awayStats.fouls += fouls;
            }
        }
    });
    
    // Update summary display
    document.getElementById('homeTeamSummary').textContent = `${homeTeamName}: ${homeScore}`;
    document.getElementById('awayTeamSummary').textContent = `${awayTeamName}: ${awayScore}`;
    
    document.getElementById('homeTeamStats').innerHTML = `
        <small class="text-muted">Players: ${homeStats.players} | Team Fouls: ${homeStats.fouls}</small>
    `;
    document.getElementById('awayTeamStats').innerHTML = `
        <small class="text-muted">Players: ${awayStats.players} | Team Fouls: ${awayStats.fouls}</small>
    `;
    
    document.getElementById('gameSummary').style.display = 'block';
}

function parseScoring(scoringString) {
    if (!scoringString) return 0;
    
    let points = 0;
    for (let char of scoringString) {
        switch (char) {
            case '1':
                points += 1; // Made free throw
                break;
            case '2':
                points += 2; // Made 2-pointer
                break;
            case '3':
                points += 3; // Made 3-pointer
                break;
            // Misses (x, -, /) don't add points
        }
    }
    return points;
}


async function saveGame() {
    try {
        // Validate form
        const homeTeamId = document.getElementById('homeTeam').value;
        const awayTeamId = document.getElementById('awayTeam').value;
        const gameDate = document.getElementById('gameDate').value;
        
        if (!homeTeamId || !awayTeamId || !gameDate) {
            showAlert('Please fill in all required fields (teams and date).', 'warning');
            return;
        }
        
        if (homeTeamId === awayTeamId) {
            showAlert('Home and away teams must be different.', 'warning');
            return;
        }
        
        // First, create any new players that were imported
        const newPlayersToCreate = [];
        document.querySelectorAll('.player-row').forEach(row => {
            if (row.dataset.newPlayer === 'true') {
                // Check if a player is already selected in the dropdown
                const playerSelect = row.querySelector('.player-select');
                const selectedValue = playerSelect ? playerSelect.value : '';
                
                // Only create if no player is selected (empty value)
                if (!selectedValue) {
                    const teamName = row.dataset.teamName;
                    const teamId = teamName.toLowerCase() === document.querySelector(`#homeTeam option[value="${homeTeamId}"]`).text.toLowerCase() 
                        ? parseInt(homeTeamId) 
                        : parseInt(awayTeamId);
                    
                    // Get the jersey number from the input field (user may have edited it)
                    const jerseyInput = row.querySelector('.jersey-input');
                    const jerseyNumber = jerseyInput ? jerseyInput.value.trim() : row.dataset.jerseyNumber;
                    
                    // Check if this is a substitute player
                    const isSubstitute = row.dataset.playerType === 'substitute';
                    
                    // For substitute players, always use Guest Players team
                    let actualTeamId = teamId;
                    if (isSubstitute) {
                        const guestTeam = teamsData.find(t => t.name === "Guest Players");
                        if (guestTeam) {
                            actualTeamId = guestTeam.id;
                        }
                    }
                    
                    newPlayersToCreate.push({
                        name: row.dataset.playerName,
                        jersey_number: jerseyNumber,
                        team_id: actualTeamId,
                        is_substitute: isSubstitute,
                        row: row
                    });
                } else {
                    // Player is already selected, just update the row to not be "new" anymore
                    row.dataset.newPlayer = 'false';
                    
                    // Update jersey display if it's still an input
                    const jerseyDisplay = row.querySelector('.jersey-display');
                    const jerseyInput = row.querySelector('.jersey-input');
                    if (jerseyDisplay && jerseyInput) {
                        const selectedOption = playerSelect.options[playerSelect.selectedIndex];
                        jerseyDisplay.innerHTML = `#${selectedOption.dataset.jerseyNumber || jerseyInput.value}`;
                    }
                }
            }
        });
        
        // Create new players if needed
        if (newPlayersToCreate.length > 0) {
            showAlert(`Creating ${newPlayersToCreate.length} new player(s)...`, 'info');
            
            for (const newPlayer of newPlayersToCreate) {
                try {
                    const response = await fetch('/v1/players/new', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: newPlayer.name,
                            jersey_number: newPlayer.jersey_number,
                            team_id: newPlayer.team_id,
                            position: null,
                            height: null,
                            weight: null,
                            year: null,
                            is_substitute: newPlayer.is_substitute || false
                        })
                    });
                    
                    if (response.ok) {
                        const createdPlayer = await response.json();
                        // Update the row with the new player ID
                        const playerSelect = newPlayer.row.querySelector('.player-select');
                        const newOption = document.createElement('option');
                        newOption.value = createdPlayer.id;
                        newOption.text = `${createdPlayer.name} (#${createdPlayer.jersey_number})`;
                        newOption.dataset.jerseyNumber = createdPlayer.jersey_number;
                        newOption.dataset.teamId = createdPlayer.team_id;
                        newOption.selected = true;
                        playerSelect.appendChild(newOption);
                        
                        // Update row to indicate player is no longer new
                        newPlayer.row.dataset.newPlayer = 'false';
                        
                        // Update the jersey display back to normal
                        const jerseyDisplay = newPlayer.row.querySelector('.jersey-display');
                        if (jerseyDisplay) {
                            jerseyDisplay.innerHTML = `#${createdPlayer.jersey_number}`;
                        }
                        
                        // Remove the warning styling from the dropdown
                        const selectedOption = playerSelect.options[playerSelect.selectedIndex];
                        if (selectedOption && selectedOption.text.includes('⚠️ NEW:')) {
                            // Find the team name from the team select
                            const teamName = newPlayer.team_id == parseInt(homeTeamId) 
                                ? document.querySelector(`#homeTeam option[value="${homeTeamId}"]`).text
                                : document.querySelector(`#awayTeam option[value="${awayTeamId}"]`).text;
                            selectedOption.text = `${createdPlayer.name} (#${createdPlayer.jersey_number}) - ${teamName}`;
                            selectedOption.classList.remove('text-warning');
                        }
                    } else {
                        let errorMessage = `Failed to create player ${newPlayer.name}`;
                        try {
                            const error = await response.json();
                            // Check if it's a jersey number conflict
                            if (error.detail && error.detail.includes('already exists')) {
                                if (error.detail.includes('jersey number')) {
                                    errorMessage = `${errorMessage}: Jersey #${newPlayer.jersey_number} is already taken. Please edit the jersey number in the table and try again.`;
                                    // Highlight the jersey input field
                                    const jerseyInput = newPlayer.row.querySelector('.jersey-input');
                                    if (jerseyInput) {
                                        jerseyInput.classList.add('is-invalid');
                                        jerseyInput.focus();
                                    }
                                } else if (error.detail.includes('team_name')) {
                                    errorMessage = `${errorMessage}: A player named "${newPlayer.name}" already exists on this team.`;
                                }
                            } else {
                                errorMessage = `${errorMessage}: ${error.detail || 'Unknown error'}`;
                            }
                        } catch (e) {
                            errorMessage = `${errorMessage}: Server error (${response.status})`;
                        }
                        showAlert(errorMessage, 'danger');
                        return;
                    }
                } catch (error) {
                    showAlert(`Error creating player ${newPlayer.name}: ${error.message}`, 'danger');
                    return;
                }
            }
        }
        
        // Collect player data
        const playerStats = [];
        let hasPlayerData = false;
        
        document.querySelectorAll('.player-row').forEach(row => {
            const playerSelect = row.querySelector('.player-select');
            const selectedOption = playerSelect.options[playerSelect.selectedIndex];
            
            if (selectedOption.value) {
                hasPlayerData = true;
                const fouls = parseInt(row.querySelector('.fouls-input').value) || 0;
                const quarters = [];
                
                row.querySelectorAll('.scoring-input').forEach(input => {
                    quarters.push(input.value || '');
                });
                
                playerStats.push({
                    player_id: parseInt(selectedOption.value),
                    player_name: selectedOption.text.split(' (')[0],
                    jersey_number: selectedOption.dataset.jerseyNumber,
                    team_id: parseInt(selectedOption.dataset.teamId),
                    fouls: fouls,
                    qt1_shots: quarters[0],
                    qt2_shots: quarters[1],
                    qt3_shots: quarters[2],
                    qt4_shots: quarters[3]
                });
            }
        });
        
        if (!hasPlayerData) {
            showAlert('Please add at least one player with statistics.', 'warning');
            return;
        }
        
        // Check if we're updating an existing game
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('game_id');
        
        // Prepare game data
        const gameData = {
            date: gameDate,
            home_team_id: parseInt(homeTeamId),
            away_team_id: parseInt(awayTeamId),
            location: document.getElementById('location').value || null,
            notes: document.getElementById('notes').value || null,
            player_stats: playerStats
        };
        
        // Add game_id if updating
        if (gameId) {
            gameData.game_id = parseInt(gameId);
        }
        
        // Save the game
        const action = gameId ? 'Updating' : 'Saving';
        showAlert(`${action} game...`, 'info');
        
        const response = await fetch('/v1/games/scorebook', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(gameData)
        });
        
        if (response.ok) {
            const result = await response.json();
            const savedAction = gameId ? 'updated' : 'saved';
            showAlert(`Game ${savedAction} successfully!`, 'success');
            
            // Optionally redirect to game detail page
            setTimeout(() => {
                window.location.href = `/games/${result.game_id}`;
            }, 2000);
        } else {
            const error = await response.json();
            showAlert(`Error ${action.toLowerCase()} game: ${error.detail}`, 'danger');
        }
        
    } catch (error) {
        console.error('Error saving game:', error);
        showAlert('Error saving game. Please try again.', 'danger');
    }
}

function showAlert(message, type) {
    // Remove existing alerts
    document.querySelectorAll('.alert').forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
    
    // Auto-dismiss info and success alerts
    if (type === 'info' || type === 'success') {
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
}

async function importCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
        const text = await file.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        let gameInfo = {};
        let playerData = [];
        let section = '';
        let headers = [];
        
        // Try parsing as new format first (with markers)
        let isNewFormat = false;
        for (let line of lines) {
            if (line.includes('GAME_INFO_KEY') || line.includes('PLAYER_STATS_HEADER')) {
                isNewFormat = true;
                break;
            }
        }
        
        if (isNewFormat) {
            // Parse new format with markers
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const parts = line.split(',').map(part => part.trim());
                
                if (parts[0] === 'GAME_INFO_KEY') {
                    section = 'game_info';
                    continue;
                } else if (parts[0] === 'PLAYER_STATS_HEADER') {
                    section = 'player_stats';
                    headers = parts.slice(1);
                    continue;
                } else if (parts[0] === 'PLAYER_DATA') {
                    section = 'player_data';
                }
                
                if (section === 'game_info' && parts.length >= 2) {
                    gameInfo[parts[0]] = parts[1];
                } else if (section === 'player_data' && parts.length > 1) {
                    const playerRow = {};
                    const data = parts.slice(1);
                    headers.forEach((header, index) => {
                        playerRow[header] = data[index] || '';
                    });
                    playerData.push(playerRow);
                }
            }
        } else {
            // Parse simpler format (Home/Away/Date rows)
            if (lines.length < 5) {
                showAlert('Invalid CSV file: File must have at least 5 rows (Home team, Away team, Date, Headers, and at least one player)', 'danger');
                return;
            }
            
            // Parse home team (row 0)
            const homeRow = lines[0].split(',').map(s => s.trim());
            if (homeRow[0].toLowerCase() !== 'home' || !homeRow[1]) {
                showAlert('Invalid CSV file: First row must be "Home,<team_name>"', 'danger');
                return;
            }
            
            // Parse away team (row 1)
            const awayRow = lines[1].split(',').map(s => s.trim());
            if (!['away', 'visitor'].includes(awayRow[0].toLowerCase()) || !awayRow[1]) {
                showAlert('Invalid CSV file: Second row must be "Away,<team_name>" or "Visitor,<team_name>"', 'danger');
                return;
            }
            
            // Parse date (row 2)
            const dateRow = lines[2].split(',').map(s => s.trim());
            if (dateRow[0].toLowerCase() !== 'date' || !dateRow[1]) {
                showAlert('Invalid CSV file: Third row must be "Date,<date>"', 'danger');
                return;
            }
            
            // Get home and away team names from the header rows
            const homeTeamFromHeader = homeRow[1];
            const awayTeamFromHeader = awayRow[1];
            gameInfo['Date'] = dateRow[1];
            
            // Parse headers (row 3)
            headers = lines[3].split(',').map(s => s.trim());
            
            // Parse player data (row 4+) and collect team names
            const teamsInData = new Set();
            for (let i = 4; i < lines.length; i++) {
                const parts = lines[i].split(',').map(s => s.trim());
                if (parts.length < 3 || !parts[0] || !parts[1] || !parts[2]) continue; // Skip empty or invalid rows
                
                const teamName = parts[0];
                teamsInData.add(teamName);
                
                const playerRow = {
                    'Team': teamName,
                    'Player Jersey': parts[1],
                    'Player Name': parts[2],
                    'Fouls': parts[3] || '0'
                };
                
                // Add quarter data
                for (let q = 1; q <= 4; q++) {
                    const headerIndex = headers.indexOf(`QT${q}`);
                    if (headerIndex >= 0 && parts[headerIndex]) {
                        playerRow[`qt${q}_shots`] = parts[headerIndex];
                    }
                }
                
                playerData.push(playerRow);
            }
            
            // Determine which team is home and which is away
            const teamsList = Array.from(teamsInData);
            if (teamsList.length !== 2) {
                showAlert(`Invalid CSV file: Expected exactly 2 teams in player data, found ${teamsList.length}: ${teamsList.join(', ')}`, 'danger');
                return;
            }
            
            // Match teams from data with home/away designation from headers
            if (homeTeamFromHeader && awayTeamFromHeader) {
                // If header specifies team names, use those
                gameInfo['Playing Team'] = homeTeamFromHeader;
                gameInfo['Opponent Team'] = awayTeamFromHeader;
            } else {
                // Otherwise, use teams from player data (first found is home, second is away)
                gameInfo['Playing Team'] = teamsList[0];
                gameInfo['Opponent Team'] = teamsList[1];
            }
        }
        
        // Validate required data with better error messages
        const missingFields = [];
        if (!gameInfo['Playing Team']) missingFields.push('Playing Team (Home team)');
        if (!gameInfo['Opponent Team']) missingFields.push('Opponent Team (Away team)');
        if (!gameInfo['Date']) missingFields.push('Date');
        
        if (missingFields.length > 0) {
            showAlert(`Invalid CSV file: Missing required game information: ${missingFields.join(', ')}`, 'danger');
            return;
        }
        
        // Clear existing form data
        clearForm(true); // Pass true to skip confirmation
        
        // Set game date - convert from M/D/YYYY to YYYY-MM-DD if needed
        if (gameInfo['Date']) {
            let dateValue = gameInfo['Date'];
            // Check if date is in M/D/YYYY format and convert to YYYY-MM-DD
            if (dateValue.includes('/')) {
                const parts = dateValue.split('/');
                if (parts.length === 3) {
                    const month = parts[0].padStart(2, '0');
                    const day = parts[1].padStart(2, '0');
                    const year = parts[2];
                    dateValue = `${year}-${month}-${day}`;
                }
            }
            document.getElementById('gameDate').value = dateValue;
        }
        
        // Find and set teams
        const homeTeamSelect = document.getElementById('homeTeam');
        const awayTeamSelect = document.getElementById('awayTeam');
        const playingTeam = gameInfo['Playing Team'];
        const opponentTeam = gameInfo['Opponent Team'];
        
        // Try to match teams in selects
        let homeTeamId = null;
        let awayTeamId = null;
        
        for (let option of homeTeamSelect.options) {
            if (option.text === playingTeam) {
                homeTeamId = option.value;
                break;
            }
        }
        
        for (let option of awayTeamSelect.options) {
            if (option.text === opponentTeam) {
                awayTeamId = option.value;
                break;
            }
        }
        
        if (!homeTeamId || !awayTeamId) {
            showAlert('Warning: Could not match all teams. Please verify team selection.', 'warning');
        } else {
            homeTeamSelect.value = homeTeamId;
            awayTeamSelect.value = awayTeamId;
        }
        
        // Add player data and track unmatched players
        const unmatchedPlayers = [];
        for (let player of playerData) {
            addPlayerRow();
            const lastRow = document.querySelector('#playerStatsBody tr:last-child');
            
            if (lastRow) {
                // Find player by name and jersey number
                const playerSelect = lastRow.querySelector('.player-select');
                const playerName = player['Player Name'] || '';
                const jerseyNumber = player['Player Jersey'] || '';
                const teamName = player['Team'] || '';
                
                // Try to find matching player
                let playerFound = false;
                for (let option of playerSelect.options) {
                    if (option.text.includes(playerName) && option.text.includes(`#${jerseyNumber}`)) {
                        playerSelect.value = option.value;
                        updatePlayerInfo(playerSelect);
                        playerFound = true;
                        break;
                    }
                }
                
                // If player not found, add to unmatched list and show in row
                if (!playerFound && playerName) {
                    unmatchedPlayers.push({
                        name: playerName,
                        jersey: jerseyNumber,
                        team: teamName
                    });
                    
                    // Check if this is an unknown player or potential substitute
                    const isUnknown = playerName.toLowerCase() === 'unknown' || playerName.toLowerCase() === 'unidentified';
                    const isSubstitute = window.substitutePlayerNames && 
                                       window.substitutePlayerNames.includes(playerName.toLowerCase());
                    
                    // Add visual indicator that this player needs to be created
                    // Update the player select to show it's a new player
                    const currentOption = playerSelect.options[playerSelect.selectedIndex];
                    if (isUnknown) {
                        currentOption.text = `❓ UNKNOWN: #${jerseyNumber} (${teamName})`;
                        currentOption.classList.add('text-danger');
                    } else if (isSubstitute) {
                        currentOption.text = `🔄 SUB: ${playerName} #${jerseyNumber} (${teamName})`;
                        currentOption.classList.add('text-info');
                    } else {
                        currentOption.text = `⚠️ NEW: ${playerName} #${jerseyNumber} (${teamName})`;
                        currentOption.classList.add('text-warning');
                    }
                    
                    // Store new player data on the row for later use
                    lastRow.dataset.newPlayer = 'true';
                    lastRow.dataset.playerType = isUnknown ? 'unknown' : (isSubstitute ? 'substitute' : 'regular');
                    lastRow.dataset.playerName = playerName;
                    lastRow.dataset.jerseyNumber = jerseyNumber;
                    lastRow.dataset.teamName = teamName;
                    
                    // Show substitute toggle button for new players (not unknown ones)
                    const substituteToggle = lastRow.querySelector('.substitute-toggle');
                    if (substituteToggle && !isUnknown) {
                        substituteToggle.style.display = '';
                        if (isSubstitute) {
                            substituteToggle.classList.remove('btn-outline-info');
                            substituteToggle.classList.add('btn-info');
                            substituteToggle.title = 'Remove substitute designation';
                        }
                    }
                    
                    // Update the team and jersey displays
                    const teamDisplay = lastRow.querySelector('.team-display');
                    const jerseyDisplay = lastRow.querySelector('.jersey-display');
                    if (teamDisplay) teamDisplay.textContent = teamName;
                    if (jerseyDisplay) {
                        // For new players, make jersey number editable
                        jerseyDisplay.innerHTML = `
                            <input type="text" class="form-control form-control-sm jersey-input" 
                                   value="${jerseyNumber}" 
                                   data-original="${jerseyNumber}"
                                   style="width: 60px;"
                                   title="Edit jersey number for new player">
                        `;
                    }
                }
                
                // Set fouls
                const foulsInput = lastRow.querySelector('.fouls-input');
                foulsInput.value = player['Fouls'] || '0';
                
                // Set quarter shots
                const scoringInputs = lastRow.querySelectorAll('.scoring-input');
                scoringInputs[0].value = player['qt1_shots'] || '';
                scoringInputs[1].value = player['qt2_shots'] || '';
                scoringInputs[2].value = player['qt3_shots'] || '';
                scoringInputs[3].value = player['qt4_shots'] || '';
            }
        }
        
        // Show warning about unmatched players
        if (unmatchedPlayers.length > 0) {
            const playersList = unmatchedPlayers.map(p => `${p.name} #${p.jersey} (${p.team})`).join(', ');
            showAlert(`Warning: ${unmatchedPlayers.length} player(s) not found in database and will need to be created: ${playersList}. You can edit their jersey numbers if needed before saving.`, 'warning');
        }
        
        // Update game summary
        updateGameSummary();
        
        showAlert('CSV file imported successfully!', 'success');
        
    } catch (error) {
        console.error('Error importing CSV:', error);
        showAlert('Error importing CSV file. Please check the file format.', 'danger');
    }
    
    // Reset file input
    event.target.value = '';
}

function clearForm(skipConfirmation = false) {
    if (!skipConfirmation && !confirm('Are you sure you want to clear all data? This cannot be undone.')) {
        return;
    }
    
    document.getElementById('homeTeam').value = '';
    document.getElementById('awayTeam').value = '';
    document.getElementById('location').value = '';
    document.getElementById('notes').value = '';
    setDefaultDate();
    
    // Remove all player rows
    document.getElementById('playerStatsBody').innerHTML = '';
    
    // Add one empty row
    addPlayerRow();
    
    // Hide summary
    document.getElementById('gameSummary').style.display = 'none';
}
</script>
{% endblock %}